name: CI

on: [push]

jobs:

  build:
    name: Run Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macOS-latest]
    steps:
    - uses: actions/checkout@v1

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.0.100
      env:
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
    
    - name: Generate EF Migrations
      env:
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      run: |
        dotnet tool install --global dotnet-ef
        cd src/Skoruba.IdentityServer4.Admin
        dotnet ef migrations add AspNetIdentityDbInit -c AdminIdentityDbContext -o Data/Migrations/Identity
        dotnet ef migrations add LoggingDbInit -c AdminLogDbContext -o Data/Migrations/Logging
        dotnet ef migrations add IdentityServerConfigurationDbInit -c IdentityServerConfigurationDbContext -o Data/Migrations/IdentityServerConfiguration
        dotnet ef migrations add IdentityServerPersistedGrantsDbInit -c IdentityServerPersistedGrantDbContext -o Data/Migrations/IdentityServerGrants
        dotnet ef migrations add AuditLoggingDbInit -c AdminAuditLogDbContext -o Data/Migrations/AdminAuditLogging

    - name: Build .NET solution
      env:
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      run: |
        dotnet --version
        dotnet build ./Skoruba.IdentityServer4.Admin.sln --configuration Release
        
    - name: Test .NET solution
      env:
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      run: |
        dotnet --version
        dotnet test ./Skoruba.IdentityServer4.Admin.sln --configuration Release
        
    - name: Build the Skoruba.IdentityServer4.Admin Docker image
      if: matrix.os != 'macOS-latest'
      run: docker build . --file src/Skoruba.IdentityServer4.Admin/Dockerfile --tag skoruba.identityserver4.admin:${{ matrix.os }}-${{ github.sha }}

    - name: Build the Skoruba.IdentityServer4.Admin.Api Docker image
      if: matrix.os != 'macOS-latest'
      run: docker build . --file src/Skoruba.IdentityServer4.Admin.Api/Dockerfile --tag skoruba.identityserver4.admin.api:${{ matrix.os }}-${{ github.sha }}

    - name: Build the Skoruba.IdentityServer4.STS.Identity Docker image
      if: matrix.os != 'macOS-latest'
      run: docker build . --file src/Skoruba.IdentityServer4.STS.Identity/Dockerfile --tag skoruba.identityserver4.sts.identity:${{ matrix.os }}-${{ github.sha }}

    - name: Validate docker-compose-ubuntu
      if: matrix.os == 'ubuntu-latest'
      run: |
        docker --version
        docker-compose --version
        docker-compose config

    - name: Validate docker-compose-windows
      if: matrix.os == 'windows-latest'
      run: |
        docker --version
        docker-compose --version
        docker-compose config

    - name: Publish skoruba.identityserver4.admin to Registry
      uses: elgohr/Publish-Docker-Github-Action@master
      if: matrix.os != 'macOS-latest'
      with:
        name: bravecobra/IdentityServer4.Admin/skoruba.identityserver4.admin:${{ matrix.os }}-${{ github.sha }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        registry: docker.pkg.github.com

    - name: Publish skoruba.identityserver4.admin.api to Registry
      uses: elgohr/Publish-Docker-Github-Action@master
      if: matrix.os != 'macOS-latest'
      with:
        name: bravecobra/IdentityServer4.Admin/skoruba.identityserver4.admin.api:${{ matrix.os }}-${{ github.sha }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        registry: docker.pkg.github.com

    - name: Publish skoruba.identityserver4.sts.identity to Registry
      uses: elgohr/Publish-Docker-Github-Action@master
      if: matrix.os != 'macOS-latest'
      with:
        name: bravecobra/IdentityServer4.Admin/skoruba.identityserver4.sts.identity:${{ matrix.os }}-${{ github.sha }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        registry: docker.pkg.github.com             
